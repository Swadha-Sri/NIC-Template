{% extends 'base/dashboard_base.html' %}
{% block title %}Solar Analytics | Desc{% endblock %}
{% block css %}
<style>
   .chart-container {
      position: relative;
      height: 350px;
      width: 100%;
   }
   .chart-container canvas {
      display: block;
   }
   .doughnut-chart-container {
      display: flex;
      justify-content: center;
      align-items: center;
   }
   .doughnut-chart-container canvas {
      max-height: 300px;
      max-width: 300px;
   }
   #solarInstalledShareChartContainer {
      height: 300px !important;
      width: 300px !important;
      margin: 0 auto;
   }
   .extra-row {
      display: none;
   }
   .rate-high {
      color: #198754 !important;
      background-color: rgba(25, 135, 84, 0.14) !important;
      font-weight: 700;
   }
   .rate-low {
      color: #dc3545 !important;
      background-color: rgba(220, 53, 69, 0.14) !important;
      font-weight: 700;
   }
   .guide-list {
      margin: 0;
      padding-left: 18px;
      font-size: 14px;
   }
   .guide-list li {
      margin-bottom: 4px;
   }
   .year-filter {
      position: relative;
      display: inline-block;
   }
   .dropdown-toggle::after {
      display: inline-block;
   }
   .filter-dropdown-menu {
      max-height: 250px;
      overflow-y: auto;
      min-width: 200px;
   }
   .stats-row {
      background-color: #f8f9fa;
   }
   .stats-row td {
      border-top: 2px solid #dee2e6;
   }
   th {
      position: relative;
      vertical-align: top;
      text-align: left;
   }
   th[title] {
      cursor: help;
      border-bottom: 2px dotted #0d6efd;
   }
   .header-main {
      display: block;
      font-weight: 700;
      margin-bottom: 4px;
   }
   .header-desc {
      display: block;
      font-size: 11px;
      font-weight: normal;
      color: #6c757d;
      white-space: normal;
      line-height: 1.3;
   }
   table tbody td {
      text-align: right;
   }
   table tbody td:first-child,
   table tbody td:nth-child(2) {
      text-align: left;
   }
   .sortable {
      cursor: pointer;
      user-select: none;
   }
   .sortable.sort-asc::after {
      content: " ▲";
      color: #0d6efd;
   }
   .sortable.sort-desc::after {
      content: " ▼";
      color: #0d6efd;
   }
   .stat-item {
      padding: 10px 0;
      border-bottom: 1px solid #dee2e6;
      font-size: 14px;
   }
   .stat-item:last-child {
      border-bottom: none;
   }

   @media print {
      @page {
         size: A4 landscape;
         margin: 8mm;
      }

      .container {
         max-width: 100% !important;
         width: 100% !important;
         padding-left: 0 !important;
         padding-right: 0 !important;
      }

      .tablecontainer {
         overflow: visible !important;
      }

      #descriptiveTable {
         width: 100% !important;
         table-layout: fixed;
         font-size: 10px;
      }

      #descriptiveTable th,
      #descriptiveTable td {
         padding: 2px 4px !important;
         white-space: normal;
         word-break: break-word;
      }

      .header-main {
         font-size: 10px;
      }

      .header-desc {
         font-size: 9px;
         line-height: 1.2;
      }

      .extra-row {
         display: table-row !important;
      }
   }
</style>
{% endblock %}
{% block content %}
            <!-- Content Row/ Breadcrumb -->
            <div class="my-5" id="b-homedb"> 
               <div class="container"> 
                  <div class="d-flex justify-content-between align-items-center mb-3">
                     <h4 class="text-center flex-grow-1 b-latest-data" style="margin: 0;">District Metrics Summary</h4>
                     <!-- Compact Year Filter Dropdown + Download -->
                     <div class="d-flex align-items-center gap-2">
                        <div class="year-filter">
                           <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" id="yearFilterBtn" data-bs-toggle="dropdown" aria-expanded="false">
                              Years <span class="badge bg-primary ms-2">{{ selected_years|length }}</span>
                           </button>
                           <ul class="dropdown-menu filter-dropdown-menu" aria-labelledby="yearFilterBtn" style="max-height: 300px; overflow-y: auto;">
                              {% for year in all_years %}
                              <li>
                                 <label class="dropdown-item mb-0">
                                    <input type="checkbox" name="year" value="{{ year }}" {% if year in selected_years %}checked{% endif %} onchange="updateYearFilter()"> 
                                    {{ year }}
                                 </label>
                              </li>
                              {% endfor %}
                           </ul>
                        </div>
                        <button class="btn btn-success btn-sm" type="button" onclick="downloadDescriptiveTableExcel()">
                           Download Excel
                        </button>
                        <button class="btn btn-outline-primary btn-sm" type="button" onclick="printDescriptivePage()">
                           Print Page
                        </button>
                     </div>
                  </div>

                  <div class="tablecontainer my-5">
                     <div class="mb-3">
                        <h5 class="mb-1">
                           Financial Year (
                           {% if selected_years %}
                              {% for year in selected_years %}
                                 {{ year }}{% if not forloop.last %}, {% endif %}
                              {% endfor %}
                           {% else %}
                              All Years
                           {% endif %}
                           )
                        </h5>
                        <p class="text-muted mb-0 small">
                           TAR: Target Achievement Rate, BRR: Booking Response Rate, ICR: Installation Conversion Rate, RR: Rejection Rate, RV: Relative Variability, SD: Standard Deviation.
                        </p>
                     </div>
                     <table id="descriptiveTable" class="table table-bordered table-striped table-sortable">
                        <thead>
                           <tr>
                              <th class="sortable" data-sort="index"><span class="header-main">S.NO</span><span class="header-desc">A</span></th>
                              <th class="sortable" data-sort="district"><span class="header-main">District</span><span class="header-desc">B</span></th>
                              <th class="sortable" data-sort="numeric" data-field="target"><span class="header-main">Target</span><span class="header-desc">C</span></th>
                              <th class="sortable" data-sort="numeric" data-field="booking"><span class="header-main">Booking</span><span class="header-desc">D</span></th>
                              <th class="sortable" data-sort="numeric" data-field="installed"><span class="header-main">Installed</span><span class="header-desc">E</span></th>
                              <th class="sortable" data-sort="numeric" data-field="rejected"><span class="header-main">Rejected</span><span class="header-desc">F</span></th>
                              <th class="sortable" data-sort="numeric" data-field="tar"><span class="header-main">TAR (%)</span><span class="header-desc">G = (E / C) × 100</span></th>
                              <th class="sortable" data-sort="numeric" data-field="brr"><span class="header-main">BRR (%)</span><span class="header-desc">H = (D / C) × 100</span></th>
                              <th class="sortable" data-sort="numeric" data-field="icr"><span class="header-main">ICR (%)</span><span class="header-desc">I = (E / D) × 100</span></th>
                              <th class="sortable" data-sort="numeric" data-field="rr"><span class="header-main">RR (%)</span><span class="header-desc">J = (F / D) × 100</span></th>
                              <th class="sortable" data-sort="numeric" data-field="rv"><span class="header-main">RV (%)</span><span class="header-desc">K = (SD / Mean)</span></th>
                              <th class="sortable" data-sort="numeric" data-field="skewness"><span class="header-main">Skewness</span><span class="header-desc">L</span></th>
                              <th class="sortable" data-sort="text"><span class="header-main">Distribution</span><span class="header-desc">M</span></th>
                              <th class="sortable" data-sort="text"><span class="header-main">Reason</span><span class="header-desc">N</span></th>
                           </tr>
                        </thead>
                        <tbody>
                           {% for row in district_table_rows %}
                              <tr class="ranking-row {% if forloop.counter > 10 %}extra-row{% endif %}" data-district="{{ row.district }}" data-original-index="{{ forloop.counter }}">
                                 <td>{{ forloop.counter }}</td>
                                 <td>{{ row.district }}</td>
                                 <td>{{ row.target }}</td>
                                 <td>{{ row.booking }}</td>
                                 <td>{{ row.installed }}</td>
                                 <td>{{ row.rejected }}</td>
                                 <td class="{% if row.target_achievement_rate < 50 %}rate-low{% else %}rate-high{% endif %}">{{ row.target_achievement_rate }}%</td>
                                 <td class="{% if row.booking_response_rate < 50 %}rate-low{% else %}rate-high{% endif %}">{{ row.booking_response_rate }}%</td>
                                 <td>{{ row.installation_conversion_rate }}%</td>
                                 <td>{{ row.rejection_rate }}%</td>
                                 <td>{{ row.relative_variability }}</td>
                                 <td>{{ row.skewness }}</td>
                                 <td>{{ row.distribution_type }}</td>
                                 <td>ABORTED TOKEN</td>
                              </tr>
                              {% endfor %}
                           <tr class="stats-row">
                              <td></td>
                              <td>TOTAL</td>
                              <td>{{ total_target }}</td>
                              <td>{{ total_booking }}</td>
                              <td>{{ total_installed }}</td>
                              <td>{{ total_rejected }}</td>
                              <td colspan="8"></td>
                           </tr>
                           <tr class="stats-row">
                              <td></td>
                              <td>MEAN</td>
                              <td>{{ mean_target }}</td>
                              <td>{{ mean_booking }}</td>
                              <td>{{ mean_installed }}</td>
                              <td>{{ mean_rejected }}</td>
                              <td>{{ mean_tar }}</td>
                              <td>{{ mean_brr }}</td>
                              <td>{{ mean_icr }}</td>
                              <td>{{ mean_rr }}</td>
                              <td>{{ cv_installed }}</td>
                              <td>{{ skew_installed }}</td>
                              <td colspan="2"></td>
                           </tr>
                           <tr class="stats-row">
                              <td></td>
                              <td>MEDIAN</td>
                              <td>{{ median_target }}</td>
                              <td>{{ median_booking }}</td>
                              <td>{{ median_installed }}</td>
                              <td>{{ median_rejected }}</td>
                              <td>{{ median_tar }}</td>
                              <td>{{ median_brr }}</td>
                              <td>{{ median_icr }}</td>
                              <td>{{ median_rr }}</td>
                              <td colspan="4"></td>
                           </tr>
                           <tr class="stats-row">
                              <td></td>
                              <td>MODE</td>
                              <td>{{ mode_target }}</td>
                              <td>{{ mode_booking }}</td>
                              <td>{{ mode_installed }}</td>
                              <td>{{ mode_rejected }}</td>
                              <td>{{ mode_tar }}</td>
                              <td>{{ mode_brr }}</td>
                              <td>{{ mode_icr }}</td>
                              <td>{{ mode_rr }}</td>
                              <td colspan="4"></td>
                           </tr>
                           <tr class="stats-row">
                              <td></td>
                              <td>STD DEV</td>
                              <td>{{ std_dev_target }}</td>
                              <td>{{ std_dev_booking }}</td>
                              <td>{{ std_dev_installed }}</td>
                              <td>{{ std_dev_rejected }}</td>
                              <td>{{ std_dev_tar }}</td>
                              <td>{{ std_dev_brr }}</td>
                              <td>{{ std_dev_icr }}</td>
                              <td>{{ std_dev_rr }}</td>
                              <td>{{ cv_icr }}</td>
                              <td>{{ skew_icr }}</td>
                              <td colspan="2"></td>
                           </tr>
                        </tbody>
                     </table>
                     <div class="text-center mt-3">
                        <button id="toggleBtn" class="btn btn-primary" onclick="toggleFullTable()">
                           Show Full Ranking
                        </button>
                     </div>                 
                  </div>

               </div>
            </div>

            <!-- Charts Section -->
            <div class="container mt-5">
               <div class="row my-5">
                  <div class="col-md-6">
                     <h4 class="text-center">Top 10 Districts (Installed)</h4>
                     <div class="chart-container">
                        <canvas id="solarYearInstalledChart"></canvas>
                     </div>
                  </div>
                  <div class="col-md-6">
                     <h4 class="text-center">Bottom 10 Districts (Intervention Required)</h4>
                     <div class="chart-container">
                        <canvas id="bottomChart"></canvas>
                     </div>
                  </div>
               </div>
               <div class="row my-5">
                  <div class="col-md-6">
                     <h4 class="text-center">Top 10 Districts (Installation Conversion Rate)</h4>
                     <div class="chart-container">
                        <canvas id="icrChart"></canvas>
                     </div>
                  </div>
                  <div class="col-md-6">
                     <h4 class="text-center">Top 10 Districts (Rejected Count)</h4>
                     <div class="chart-container">
                        <canvas id="rejectedDiffChart"></canvas>
                     </div>
                  </div>
               </div>
               <div class="row my-5">
                  <div class="col-md-6">
                     <h4 class="text-center">Pending Installations</h4>
                     <div class="chart-container">
                        <canvas id="bookingDiffChart"></canvas>
                     </div>
                  </div>
                  <div class="col-md-6">
                     <h4 class="text-center">Skewness Classification</h4>
                     <div class="chart-container doughnut-chart-container">
                        <canvas id="skewnessClassificationChart"></canvas>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      {% endblock %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>

   function getHiddenExtraRows() {
      const extraRows = Array.from(document.querySelectorAll('.extra-row'));
      return extraRows.filter((row) => window.getComputedStyle(row).display === 'none');
   }

   function showAllRowsForOutput() {
      const hiddenRows = getHiddenExtraRows();
      hiddenRows.forEach((row) => {
         row.style.display = 'table-row';
      });
      return hiddenRows;
   }

   function restoreRowsAfterOutput(hiddenRows) {
      hiddenRows.forEach((row) => {
         row.style.display = 'none';
      });
   }

   function printDescriptivePage() {
      const hiddenRows = showAllRowsForOutput();
      window.print();
      restoreRowsAfterOutput(hiddenRows);
   }

   function downloadDescriptiveTableExcel() {
      const table = document.getElementById('descriptiveTable');
      if (!table || typeof XLSX === 'undefined') {
         return;
      }

      const hiddenRows = showAllRowsForOutput();

      const workbook = XLSX.utils.table_to_book(table, { sheet: 'District Metrics' });
      const fileName = `district_metrics_summary_${new Date().toISOString()}.xlsx`;
      XLSX.writeFile(workbook, fileName);

      restoreRowsAfterOutput(hiddenRows);
   }

   function updateYearFilter() {
      const checkboxes = document.querySelectorAll('input[name="year"]:checked');
      const years = Array.from(checkboxes).map(cb => cb.value);
      
      if (years.length === 0) {
         const allCheckboxes = document.querySelectorAll('input[name="year"]');
         years.push(...Array.from(allCheckboxes).map(cb => cb.value));
      }
      
      const params = new URLSearchParams();
      years.forEach(year => params.append('year', year));
      window.location.href = `?${params.toString()}`;
   }

   // Table Sorting Function
   function sortTable(columnIndex, sortType) {
      const table = document.querySelector('table.table-sortable');
      const tbody = table.querySelector('tbody');
      const rows = Array.from(tbody.querySelectorAll('tr:not(.stats-row)'));
      const statsRows = Array.from(tbody.querySelectorAll('tr.stats-row'));
      const isAsc = table.dataset.sortColumn === columnIndex && table.dataset.sortDir === 'asc';
      const direction = isAsc ? 'desc' : 'asc';

      rows.sort((a, b) => {
         if (sortType === 'index') {
            const aIndex = parseInt(a.dataset.originalIndex, 10) || 0;
            const bIndex = parseInt(b.dataset.originalIndex, 10) || 0;
            return direction === 'asc' ? (aIndex - bIndex) : (bIndex - aIndex);
         }

         const aVal = a.cells[columnIndex].textContent.trim();
         const bVal = b.cells[columnIndex].textContent.trim();

         let comparison = 0;
         if (sortType === 'numeric') {
            const aNum = parseFloat(aVal.replace('%', '')) || 0;
            const bNum = parseFloat(bVal.replace('%', '')) || 0;
            comparison = aNum - bNum;
         } else {
            comparison = aVal.localeCompare(bVal);
         }

         return direction === 'asc' ? comparison : -comparison;
      });

      rows.forEach((row, index) => {
         row.cells[0].textContent = index + 1;
         tbody.appendChild(row);
      });

      statsRows.forEach((row) => {
         tbody.appendChild(row);
      });

      table.dataset.sortColumn = columnIndex;
      table.dataset.sortDir = direction;

      // Update header indicators
      document.querySelectorAll('th.sortable').forEach(th => {
         th.classList.remove('sort-asc', 'sort-desc');
      });
      table.querySelectorAll('th.sortable')[columnIndex].classList.add(`sort-${direction}`);
   }

   // Attach sorting to headers
   document.addEventListener('DOMContentLoaded', function () {
      document.querySelectorAll('th.sortable').forEach((th, index) => {
         th.style.cursor = 'pointer';
         th.addEventListener('click', function() {
            const sortType = this.dataset.sort || 'text';
            sortTable(index, sortType);
         });
      });
   });

   function toggleFullTable() {
      const extraRows = document.querySelectorAll(".extra-row");
      const btn = document.getElementById("toggleBtn");

      if (!extraRows.length) {
         return;
      }
   
      const isHidden = extraRows[0].style.display === "" || extraRows[0].style.display === "none";
   
      extraRows.forEach(row => {
         row.style.display = isHidden ? "table-row" : "none";
      });
   
      btn.innerText = isHidden ? "Hide Full Ranking" : "Show Full Ranking";
   }
   
   Chart.register(ChartDataLabels);

   let solarInstalledShareChartInstance = null;
   
   document.addEventListener("DOMContentLoaded", function () {
      const topLabels = {{ solar_top_labels|safe }};
      const topInstalled = {{ solar_top_installed|safe }};
      const meanInstalled = {{ mean_installed_value }};
      const meanRejected = {{ mean_rejected_value }};
      const meanBookingDiff = {{ mean_booking_diff_value }};

      const solarYearInstalledChart = document.getElementById("solarYearInstalledChart");
      if (solarYearInstalledChart) {
         new Chart(solarYearInstalledChart, {
            type: "bar",
            data: {
               labels: topLabels,
               datasets: [
                  {
                     label: "Installed",
                     data: topInstalled,
                     backgroundColor: "rgba(66, 235, 54, 0.7)",
                  },
                  {
                     label: `mean - ${meanInstalled}`,
                     type: "line",
                     data: Array(topLabels.length).fill(meanInstalled),
                     borderColor: "rgba(255, 0, 0, 1)",
                     borderWidth: 2,
                     fill: false,
                     tension: 0
                  }
               ],
            },
            options: {
               responsive: true,
               scales: {
                  y: { 
                     beginAtZero: true,
                  },
               },
               plugins: {
                  legend: {
                     display: true,
                  },
                  datalabels: {
                     display: function(context) {
                        return context.dataset.type !== 'line';
                     },
                     color: '#000',
                     anchor: 'end',
                     align: 'top',
                     font: {
                        weight: 'bold'
                     }
                  },
                  tooltip: {
                     callbacks: {
                        label: function(context) {
                           return context.dataset.label + ': ' + context.parsed.y;
                        }
                     }
                  }
               }
            },
         });
      }

      const bottomChart = document.getElementById("bottomChart");
      const bottomLabels = {{ bottom_labels|safe }};
      const bottomInstalled = {{ bottom_installed|safe }};

      if (bottomChart) {
         new Chart(bottomChart, {
            type: "bar",
            data: {
               labels: bottomLabels,
               datasets: [
                  {
                     label: "Installed",
                     data: bottomInstalled,
                     backgroundColor: "rgba(255, 99, 132, 0.7)"
                  },
               ]
            },
            options: {
               responsive: true,
               scales: {
                  y: {
                     beginAtZero: true
                  }
               },
               plugins: {
                  legend: {
                     display: true,
                  },
                  datalabels: {
                     display: function(context) {
                        return context.dataset.type !== 'line';
                     },
                     color: '#000',
                     anchor: 'end',
                     align: 'top',
                     font: {
                        weight: 'bold'
                     }
                  }
               }
            }
         });
      }

      const icrChart = document.getElementById("icrChart");
      const icrLabels = {{ icr_labels|safe }};
      const icrValues = {{ icr_values|safe }};
      const meanICR = {{ mean_icr_value }};

      if (icrChart) {
         new Chart(icrChart, {
            type: "bar",
            data: {
               labels: icrLabels,
               datasets: [
                  {
                     label: "ICR (%)",
                     data: icrValues,
                     backgroundColor: "rgba(156, 102, 255, 0.7)"
                  },
                  {
                     label: `mean - ${meanICR}`,
                     type: "line",
                     data: Array(icrLabels.length).fill(meanICR),
                     borderColor: "rgba(255, 165, 0, 1)",
                     borderWidth: 2,
                     fill: false,
                     tension: 0
                  }
               ]
            },
            options: {
               responsive: true,
               scales: {
                  y: {
                     beginAtZero: true
                  }
               },
               plugins: {
                  legend: {
                     display: true,
                  },
                  datalabels: {
                     display: function(context) {
                        return context.dataset.type !== 'line';
                     },
                     color: '#000',
                     anchor: 'end',
                     align: 'top',
                     font: {
                        weight: 'bold'
                     }
                  }
               }
            }
         });
      }

      const rejectedDiffChart = document.getElementById("rejectedDiffChart");
      const rejectedDiffLabels = {{ rejected_diff_labels|safe }};
      const rejectedDiffValues = {{ rejected_diff_values|safe }};
      if (rejectedDiffChart) {
         new Chart(rejectedDiffChart, {
            type: "bar",
            data: {
               labels: rejectedDiffLabels,
               datasets: [
                  {
                     label: "Rejected",
                     data: rejectedDiffValues,
                     backgroundColor: "rgba(75, 192, 192, 0.7)"
                  },
                  {
                     label: `mean - ${meanRejected}`,
                     type: "line",
                     data: Array(rejectedDiffLabels.length).fill(meanRejected),
                     borderColor: "rgba(255, 0, 0, 1)",
                     borderWidth: 2,
                     fill: false,
                     tension: 0
                  }
               ]
            },
            options: {
               responsive: true,
               scales: {
                  y: {
                     beginAtZero: true
                  }
               },
               plugins: {
                  legend: {
                     display: true,
                  },
                  datalabels: {
                     display: function(context) {
                        return context.dataset.type !== 'line';
                     },
                     color: '#000',
                     anchor: 'end',
                     align: 'top',
                     font: {
                        weight: 'bold'
                     }
                  }
               }
            }
         });
      }


      const bookingDiffChart = document.getElementById("bookingDiffChart");
      const bookingDiffLabels = {{ booking_diff_labels|safe }};
      const bookingDiffValues = {{ booking_diff_values|safe }};

      if (bookingDiffChart) {
         new Chart(bookingDiffChart, {
            type: "bar",
            data: {
               labels: bookingDiffLabels,
               datasets: [
                  {
                     label: "Booking - Installed",
                     data: bookingDiffValues,
                     backgroundColor: "rgba(54, 162, 235, 0.7)",
                  },
                  {
                     label: `mean - ${meanBookingDiff}`,
                     type: "line",
                     data: Array(bookingDiffLabels.length).fill(meanBookingDiff),
                     borderColor: "rgba(255, 0, 0, 1)",
                     borderWidth: 2,
                     fill: false,
                     tension: 0
                  }
               ]
            },
            options: {
               responsive: true,
               scales: {
                  y: { beginAtZero: true }
               },
               plugins: {
                  legend: {
                     display: true,
                  },
                  datalabels: {
                     display: function(context) {
                        return context.dataset.type !== 'line';
                     },
                     color: '#000',
                     anchor: 'end',
                     align: 'top',
                     font: {
                        weight: 'bold'
                     }
                  }
               }
            }
         });
      }

      const skewnessClassificationChart = document.getElementById("skewnessClassificationChart");
      if (skewnessClassificationChart) {
         const districtRows = Array.from(document.querySelectorAll('#descriptiveTable tbody tr.ranking-row'));
         const skewnessCounts = {
            'Right Skewed': 0,
            'Approximately Symmetric': 0,
            'Left Skewed': 0,
         };

         districtRows.forEach((row) => {
            const classificationCell = row.cells[12];
            const classification = classificationCell ? classificationCell.textContent.trim() : '';

            if (classification === 'Right Skewed') {
               skewnessCounts['Right Skewed'] += 1;
            } else if (classification === 'Left Skewed') {
               skewnessCounts['Left Skewed'] += 1;
            } else if (classification === 'Approximately Symmetric') {
               skewnessCounts['Approximately Symmetric'] += 1;
            }
         });

         const labels = ['Right Skewed', 'Approximately Symmetric', 'Left Skewed'];
         const values = labels.map((key) => skewnessCounts[key]);
         const total = values.reduce((acc, value) => acc + value, 0);

         new Chart(skewnessClassificationChart, {
            type: 'doughnut',
            data: {
               labels: labels,
               datasets: [{
                  data: values,
                  backgroundColor: [
                     'rgba(40, 167, 69, 0.8)',
                     'rgba(13, 110, 253, 0.8)',
                     'rgba(220, 53, 69, 0.8)'
                  ],
                  borderColor: [
                     'rgba(40, 167, 69, 1)',
                     'rgba(13, 110, 253, 1)',
                     'rgba(220, 53, 69, 1)'
                  ],
                  borderWidth: 1
               }]
            },
            options: {
               responsive: true,
               plugins: {
                  legend: {
                     display: true,
                     position: 'bottom'
                  },
                  datalabels: {
                     color: '#fff',
                     font: {
                        weight: 'bold'
                     },
                     formatter: function(value) {
                        if (!value) {
                           return null;
                        }
                        if (!total) {
                           return value;
                        }
                        const percentage = ((value / total) * 100).toFixed(1);
                        return `${value} (${percentage}%)`;
                     }
                  }
               }
            }
         });
      }

   });
</script>
{% endblock %}
