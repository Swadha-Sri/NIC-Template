{% extends 'base/dashboard_base.html' %}
{% load static %}
{% block title %}Solar Analytics | Dashboard{% endblock %}
{% block css %}
<style>
   .chart-container {
      position: relative;
      height: 350px;
      width: 100%;
   }
   .chart-container canvas {
      display: block;
   }
   #solarInstalledShareChartContainer {
      height: 300px !important;
      width: 300px !important;
      margin: 0 auto;
   }
   .extra-row {
      display: none;
   }
</style>
{% endblock %}
{% block content %}
            <!-- Content Row/ Breadcrumb -->
            <div class="my-5" id="b-homedb"> 
               <div class="container">
                  <h1 class="text-center mb-3">Data Analysis Dashboard of PM KUSUM Yojna for Solar Pump Subsity of Uttar Pradesh</h1>
                  {% if messages %}
                  <div class="mb-3">
                     {% for message in messages %}
                     <div class="alert alert-{{ message.tags|default:'info' }}" role="alert">{{ message }}</div>
                     {% endfor %}
                  </div>
                  {% endif %}
                  <div class="">
                     <div class="row text-center pl-4" id="sortable-cards">
                        <div class="col-lg-6 col-sm-12 p-3 b-customize">
                           <div class="bg-light p-4 b-dbcard">
                              <i class="fas fa-bullseye position-absolute" style="font-size:35px; right: 40px; top: 40px;"></i>
                              <div class="">
                                 <p class="text-start fw-bold" style="font-size: 14px;">Total Target (All Years)</p>
                                 <h3 class="text-start fw-bold" style="margin-top: -5px">{{ solar_total_target }}</h3>
                                 <div class="text-start" style="margin: 10px 0px 5px;">
                                    <span class="badge bg-info">Overall</span>
                                    <span style="font-size:13px;"> Target capacity</span>
                                 </div>
                              </div>
                           </div>
                        </div>
                        <div class="col-lg-6 col-sm-12 p-3 b-customize">
                           <div class="bg-light p-4 b-dbcard">
                              <i class="fas fa-book position-absolute" style="font-size:35px; right: 40px; top: 40px;"></i>
                              <div class="">
                                 <p class="text-start fw-bold" style="font-size: 14px;">Total Booking (All Years)</p>
                                 <h3 class="text-start fw-bold" style="margin-top: -5px">{{ solar_total_booking }}</h3>
                                 <div class="text-start" style="margin: 10px 0px 5px;">
                                    <span class="badge bg-info">Overall</span>
                                    <span style="font-size:13px;"> Booking count</span>
                                 </div>
                              </div>
                           </div>
                        </div>
                        <div class="col-lg-6 col-sm-12 p-3 b-customize">
                           <div class="bg-light p-4 b-dbcard">
                              <i class="fas fa-solar-panel position-absolute" style="font-size:35px; right: 40px; top: 40px;"></i>
                              <div class="">
                                 <p class="text-start fw-bold" style="font-size: 14px;">Total Installed (All Years)</p>
                                 <h3 class="text-start fw-bold" style="margin-top: -5px">{{ solar_total_installed }}</h3>
                                 <div class="text-start" style="margin: 10px 0px 5px;">
                                    <span class="badge bg-success">{{ solar_install_rate }}</span>
                                    <span style="font-size:13px;"> Install rate</span>
                                 </div>
                              </div>
                           </div>
                        </div>
                        <div class="col-lg-6 col-sm-12 p-3 b-customize">
                           <div class="bg-light p-4 b-dbcard">
                              <i class="fas fa-ban position-absolute" style="font-size:35px; right: 40px; top: 40px;"></i>
                              <div class="">
                                 <p class="text-start fw-bold" style="font-size: 14px;">Rejection Rate</p>
                                 <h3 class="text-start fw-bold" style="margin-top: -5px">{{ solar_reject_rate }}</h3>
                                 <div class="text-start" style="margin: 10px 0px 5px;">
                                    <span class="badge bg-warning text-dark">Overall</span>
                                    <span style="font-size:13px;"> Rejected vs booking</span>
                                 </div>
                              </div>
                           </div>
                        </div>
                     </div>
                  </div>
               </div>
            </div>
            <h4 class="text-center mb-3 b-latest-data">Upload Excel Data for Solar Pump</h4>
            <div class="text-center mb-4">
               <a href="{% url 'download_solar_pump_data' %}" class="btn btn-primary"><i class="fas fa-download me-2"></i>Download Format File</a>
            </div>
            <p class="text-center">The data should be district wise and according to the given format.</p>
            <div class="container mb-4">
               <form id="solarUploadForm" method="post" enctype="multipart/form-data" class="row g-2 justify-content-center align-items-center">
                  {% csrf_token %}
                  <input type="hidden" name="confirm_upload" id="confirmUploadInput" value="no">
                  <div class="col-md-6 col-sm-12">
                     <input type="file" class="form-control" name="solar_data_file" accept=".xlsx" required>
                  </div>
                  <div class="col-md-auto col-sm-12">
                     <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-upload me-2"></i>Upload File
                     </button>
                  </div>
               </form>
            </div>

            <div class="container mb-5">
               <div class="card">
                  <div class="card-header fw-bold">Uploaded Files</div>
                  <div class="table-responsive">
                     <table class="table mb-0 align-middle">
                        <thead>
                           <tr>
                              <th>File Name</th>
                              <th>Year</th>
                              <th>Uploaded By</th>
                              <th>Uploaded At</th>
                              <th class="text-end">Actions</th>
                           </tr>
                        </thead>
                        <tbody>
                           {% for uploaded_file in uploaded_files %}
                           <tr>
                              <td>{{ uploaded_file.original_filename }}</td>
                              <td>{{ uploaded_file.year_label }}</td>
                              <td>{{ uploaded_file.uploaded_by.username|default:'-' }}</td>
                              <td>{{ uploaded_file.uploaded_at|date:"Y-m-d H:i" }}</td>
                              <td class="text-end">
                                 <a href="{% url 'view_uploaded_file_data' uploaded_file.id %}" class="btn btn-sm btn-outline-primary">View</a>
                                 <a href="{% url 'download_uploaded_file' uploaded_file.id %}" class="btn btn-sm btn-outline-success">Download</a>
                                 <form method="post" action="{% url 'delete_uploaded_file' uploaded_file.id %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Delete this file?');">Delete</button>
                                 </form>
                              </td>
                           </tr>
                           {% empty %}
                           <tr>
                              <td colspan="5" class="text-center text-muted py-3">No files uploaded yet.</td>
                           </tr>
                           {% endfor %}
                        </tbody>
                     </table>
                  </div>
               </div>
            </div>
         </div>
      {% endblock %}

{% block js %}
<script>
   document.addEventListener("DOMContentLoaded", function () {
      const uploadForm = document.getElementById("solarUploadForm");
      const confirmUploadInput = document.getElementById("confirmUploadInput");

      if (!uploadForm || !confirmUploadInput) {
         return;
      }

      uploadForm.addEventListener("submit", function (event) {
         const isConfirmed = window.confirm("Are you sure that you want to upload this file?");
         if (!isConfirmed) {
            confirmUploadInput.value = "no";
            event.preventDefault();
            return;
         }

         confirmUploadInput.value = "yes";
      });
   });
</script>
{% endblock %}
